#!/usr/bin/env bash
set -eou pipefail

export AWS_PROFILE="$1"

credentials_path="/tmp/aws-credentials-${AWS_PROFILE}"

if [[ -f ${credentials_path} ]]; then
	expiration=$(jq -r .Expiration "${credentials_path}")
	if [[ "$(date -u +%FT%TZ)" < ${expiration} ]]; then
		cat "${credentials_path}"
		exit
	fi
fi

credentials_text=$(aws sts get-session-token \
	--duration-seconds 129600 \
	--output text \
	--profile "${AWS_PROFILE}-long-term" \
	--query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken,Expiration]" \
	--serial-number "$(aws configure get mfa_serial)" \
	--token-code "$(eval "$(aws configure get mfa_process)")")

printf '{"Version":1,"AccessKeyId":"%s","SecretAccessKey":"%s","SessionToken":"%s","Expiration":"%s"}' ${credentials_text} | tee "${credentials_path}"
